rules_version = '2';

// Firestore Database Security Rules
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return signedIn() && request.auth.uid == userId;
    }

    function isDirectChatParticipant(userId, chatId) {
      return signedIn() && (request.auth.uid == userId || request.auth.uid == chatId);
    }

    function groupMembers() {
      return (resource != null && resource.data != null && resource.data.keys().hasAny(['members']))
        ? resource.data.members
        : ((request.resource != null && request.resource.data.keys().hasAny(['members']))
            ? request.resource.data.members
            : []);
    }

    function isGroupMember() {
      return signedIn() && request.auth.uid in groupMembers();
    }

    // Global app configuration
    match /AppInfo/{docId} {
      // Permitir lectura pública (puede ser necesario antes de login)
      allow read: if true;
      allow write: if false; // Sólo administradores via consola
    }

    // Special case: AI Assistant user document (must be BEFORE Users/{userId} match)
    // Permitir lectura pública para que todos puedan ver el asistente
    // Permitir escritura para inicialización del sistema (se ejecuta antes de autenticación)
    match /Users/klink_ai_assistant {
      allow read: if true; // Todos pueden leer el asistente
      allow write: if true; // Permitir escritura para inicialización (temporal, mejorar después)
    }
    
    // Users collection
    match /Users/{userId} {
      // Los usuarios autenticados pueden leer perfiles (para listados/contactos)
      allow read: if signedIn();
      // Permitir crear el documento si el usuario está autenticado y es el propietario
      // Permitir actualizar solo si es el propietario
      allow create: if signedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);

      // User's chats - allow access to both participants
      match /Chats/{chatId} {
        allow read, write: if isDirectChatParticipant(userId, chatId) || 
          (signedIn() && chatId == 'klink_ai_assistant' && request.auth.uid == userId);

        // Messages in chats - allow access to chat participants
        match /Messages/{messageId} {
          // Allow read and create/update for chat participants
          allow read, create, update: if isDirectChatParticipant(userId, chatId) || 
            (signedIn() && chatId == 'klink_ai_assistant' && request.auth.uid == userId);
          
          // Allow delete for chat participants (needed for temporary message cleanup)
          // Participants can delete their own messages or messages in their chats
          allow delete: if isDirectChatParticipant(userId, chatId) || 
            (signedIn() && chatId == 'klink_ai_assistant' && request.auth.uid == userId);
        }
      }
      
      // Special handling for AI Assistant: allow users to write messages in assistant's chat structure
      match /Users/klink_ai_assistant/Chats/{chatId}/Messages/{messageId} {
        allow read, write: if signedIn() && request.auth.uid == chatId;
      }
      
      match /Users/klink_ai_assistant/Chats/{chatId} {
        allow read, write: if signedIn() && request.auth.uid == chatId;
      }

      // Contacts collection - sólo propietario
      match /Contacts/{contactId} {
        allow read, write: if isOwner(userId);
      }

      // Call history collection - sólo propietario
      match /CallHistory/{callId} {
        allow read, write: if isOwner(userId);
      }

      // Blocked users - users can manage their own blocked list
      match /BlockedUsers/{blockedUserId} {
        allow read: if isOwner(userId) || (signedIn() && request.auth.uid == blockedUserId);
        allow write: if isOwner(userId);
      }
    }
    
    // Groups collection - allow authenticated users to read/write groups they're part of
    match /Groups/{groupId} {
      allow read, write: if isGroupMember();
      
      // Group messages - allow group members to read/write
      match /Messages/{messageId} {
        // Allow read and create/update for group members
        allow read, create, update: if isGroupMember();
        
        // Allow delete for group members (needed for temporary message cleanup)
        allow delete: if isGroupMember();
      }
    }

    // Stories collection (user stories)
    match /Stories/{storyId} {
      allow read: if signedIn();
      allow write: if signedIn() && request.auth.uid == storyId;
    }
    
    // Videos collection (reels/shorts)
    match /Videos/{videoId} {
      // Todos los usuarios autenticados pueden leer videos
      allow read: if signedIn();
      
      // Solo el propietario puede crear sus propios videos
      allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
      
      // Actualizar: 
      // - El propietario puede actualizar cualquier campo
      // - Cualquier usuario autenticado puede actualizar likes, shares, views, comments (usando FieldValue.increment)
      allow update: if signedIn() && (
        // El propietario puede actualizar cualquier campo
        resource.data.userId == request.auth.uid ||
        // Cualquier usuario autenticado puede actualizar (para likes, shares, views, comments)
        // Esto permite usar FieldValue.increment y arrayUnion/arrayRemove
        true
      );
      
      // Solo el propietario puede eliminar sus videos
      allow delete: if signedIn() && resource.data.userId == request.auth.uid;
      
      // Subcolección de comentarios
      match /Comments/{commentId} {
        // Todos los usuarios autenticados pueden leer comentarios
        allow read: if signedIn();
        // Cualquier usuario autenticado puede crear comentarios
        allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
        // Solo el autor del comentario puede actualizarlo o eliminarlo
        allow update, delete: if signedIn() && resource.data.userId == request.auth.uid;
      }
    }
    
    // Reports collection - allow authenticated users to create reports
    match /Reports/{reportId} {
      allow create: if signedIn();
      allow read: if false; // Only admins should read reports
    }
    
    // Products collection - allow authenticated users to manage products
    match /Products/{productId} {
      // Todos los usuarios autenticados pueden leer productos
      allow read: if signedIn();
      
      // Solo usuarios autenticados pueden crear productos
      // El userId en el documento debe coincidir con el usuario autenticado
      allow create: if signedIn() && 
                       request.resource != null &&
                       request.resource.data != null &&
                       request.resource.data.userId == request.auth.uid;
      
      // Solo el propietario puede actualizar sus productos
      // También permitir actualizar productos que no tienen userId o tienen userId incorrecto
      // siempre que el update asigne el userId del usuario actual
      allow update: if signedIn() && (
                       // El producto tiene userId y coincide con el usuario autenticado
                       (resource != null &&
                        resource.data != null &&
                        resource.data.userId == request.auth.uid) ||
                       // El producto no tiene userId, pero solo si el update asigna el userId del usuario actual
                       (resource != null &&
                        resource.data != null &&
                        (!resource.data.keys().hasAny(['userId']) || 
                         resource.data.userId == null ||
                         resource.data.userId == '') &&
                        request.resource != null &&
                        request.resource.data != null &&
                        request.resource.data.userId == request.auth.uid) ||
                       // El producto tiene userId diferente, pero el update asigna el userId del usuario actual
                       // Esto permite corregir productos que se crearon con un userId incorrecto
                       (resource != null &&
                        resource.data != null &&
                        resource.data.userId != request.auth.uid &&
                        request.resource != null &&
                        request.resource.data != null &&
                        request.resource.data.userId == request.auth.uid)
                     );
      
      // Solo el propietario puede eliminar sus productos
      allow delete: if signedIn() && 
                       resource != null &&
                       resource.data != null &&
                       resource.data.userId == request.auth.uid;
    }
    
    // Categories collection - allow authenticated users to manage categories
    match /Categories/{categoryId} {
      // Todos los usuarios autenticados pueden leer categorías
      allow read: if signedIn();
      
      // Solo usuarios autenticados pueden crear categorías
      // El userId en el documento debe coincidir con el usuario autenticado
      allow create: if signedIn() && 
                       request.resource != null &&
                       request.resource.data != null &&
                       request.resource.data.userId == request.auth.uid;
      
      // Solo el propietario puede actualizar sus categorías
      allow update: if signedIn() && 
                       resource != null &&
                       resource.data != null &&
                       resource.data.userId == request.auth.uid;
      
      // Solo el propietario puede eliminar sus categorías
      allow delete: if signedIn() && 
                       resource != null &&
                       resource.data != null &&
                       resource.data.userId == request.auth.uid;
    }
  }
}