rules_version = '2';

// Firestore Database Security Rules
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return signedIn() && request.auth.uid == userId;
    }

    function isDirectChatParticipant(userId, chatId) {
      return signedIn() && (request.auth.uid == userId || request.auth.uid == chatId);
    }

    function groupMembers() {
      return (resource != null && resource.data != null && resource.data.keys().hasAny(['members']))
        ? resource.data.members
        : ((request.resource != null && request.resource.data.keys().hasAny(['members']))
            ? request.resource.data.members
            : []);
    }

    function isGroupMember() {
      return signedIn() && request.auth.uid in groupMembers();
    }

    // Global app configuration
    match /AppInfo/{docId} {
      allow read: if signedIn();
      allow write: if false; // S贸lo administradores via consola
    }

    // Users collection
    match /Users/{userId} {
      // Los usuarios autenticados pueden leer perfiles (para listados/contactos)
      allow read: if signedIn();
      // Cada usuario s贸lo puede escribir su propio documento
      allow write: if isOwner(userId);

      // User's chats - allow access to both participants
      match /Chats/{chatId} {
        allow read, write: if isDirectChatParticipant(userId, chatId) || 
          (signedIn() && chatId == 'klink_ai_assistant' && request.auth.uid == userId);

        // Messages in chats - allow access to chat participants
        match /Messages/{messageId} {
          allow read, write: if isDirectChatParticipant(userId, chatId) || 
            (signedIn() && chatId == 'klink_ai_assistant' && request.auth.uid == userId);
        }
      }
      
      // Special handling for AI Assistant: allow users to write messages in assistant's chat structure
      match /Users/klink_ai_assistant/Chats/{chatId}/Messages/{messageId} {
        allow read, write: if signedIn() && request.auth.uid == chatId;
      }
      
      match /Users/klink_ai_assistant/Chats/{chatId} {
        allow read, write: if signedIn() && request.auth.uid == chatId;
      }

      // Contacts collection - s贸lo propietario
      match /Contacts/{contactId} {
        allow read, write: if isOwner(userId);
      }

      // Call history collection - s贸lo propietario
      match /CallHistory/{callId} {
        allow read, write: if isOwner(userId);
      }

      // Blocked users - users can manage their own blocked list
      match /BlockedUsers/{blockedUserId} {
        allow read: if isOwner(userId) || (signedIn() && request.auth.uid == blockedUserId);
        allow write: if isOwner(userId);
      }
    }
    
    // Groups collection - allow authenticated users to read/write groups they're part of
    match /Groups/{groupId} {
      allow read, write: if isGroupMember();
      
      // Group messages - allow group members to read/write
      match /Messages/{messageId} {
        allow read, write: if isGroupMember();
      }
    }

    // Stories collection (user stories)
    match /Stories/{storyId} {
      allow read: if signedIn();
      allow write: if signedIn() && request.auth.uid == storyId;
    }
    
    // Reports collection - allow authenticated users to create reports
    match /Reports/{reportId} {
      allow create: if signedIn();
      allow read: if false; // Only admins should read reports
    }
    
    // Special case: AI Assistant user document (must be outside Users/{userId} match)
    match /Users/klink_ai_assistant {
      allow read: if signedIn();
      allow write: if false; // Only system can write
    }
  }
}